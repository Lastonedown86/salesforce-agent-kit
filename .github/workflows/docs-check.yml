name: Documentation Check

on:
  pull_request:
    branches:
      - main

jobs:
  check-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for significant changes requiring README update
        id: check-changes
        run: |
          # Get changed files in PR
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if significant changes were made
          SIGNIFICANT_CHANGES=false
          README_UPDATED=false
          
          # Check for new skills, agents, or workflows
          if echo "$CHANGED_FILES" | grep -qE "^\.agent/(skills|agents|workflows)/.*\.md$"; then
            SIGNIFICANT_CHANGES=true
            echo "::notice::New skill, agent, or workflow files detected"
          fi
          
          # Check for CLI command changes
          if echo "$CHANGED_FILES" | grep -qE "^src/commands/"; then
            SIGNIFICANT_CHANGES=true
            echo "::notice::CLI command changes detected"
          fi
          
          # Check for new categories in skills
          NEW_CATEGORIES=$(echo "$CHANGED_FILES" | grep -oE "^\.agent/skills/[^/]+" | sort -u | while read dir; do
            if [ -n "$dir" ] && ! git ls-tree -d origin/main "$dir" &>/dev/null; then
              echo "$dir"
            fi
          done)
          
          if [ -n "$NEW_CATEGORIES" ]; then
            SIGNIFICANT_CHANGES=true
            echo "::notice::New skill categories detected: $NEW_CATEGORIES"
          fi
          
          # Check if README was updated
          if echo "$CHANGED_FILES" | grep -q "^README.md$"; then
            README_UPDATED=true
          fi
          
          echo "significant_changes=$SIGNIFICANT_CHANGES" >> $GITHUB_OUTPUT
          echo "readme_updated=$README_UPDATED" >> $GITHUB_OUTPUT

      - name: Warn if README not updated for significant changes
        if: steps.check-changes.outputs.significant_changes == 'true' && steps.check-changes.outputs.readme_updated == 'false'
        run: |
          echo "::warning::Significant changes detected but README.md was not updated."
          echo ""
          echo "ðŸ“ Please consider updating README.md if you've added:"
          echo "   - New skills or skill categories"
          echo "   - New agents or workflows"
          echo "   - New CLI commands or options"
          echo "   - New features that users should know about"
          echo ""
          echo "This is a reminder, not a blocking error."

      - name: Validate README structure
        run: |
          echo "Checking README.md structure..."
          
          # Check for required sections
          REQUIRED_SECTIONS=(
            "## Quick Start"
            "## Available Skills"
            "## Commands"
          )
          
          MISSING_SECTIONS=()
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -q "$section" README.md; then
              MISSING_SECTIONS+=("$section")
            fi
          done
          
          if [ ${#MISSING_SECTIONS[@]} -gt 0 ]; then
            echo "::error::README.md is missing required sections: ${MISSING_SECTIONS[*]}"
            exit 1
          fi
          
          echo "âœ… README.md has all required sections"

      - name: Check skill count in README matches actual
        run: |
          echo "Validating skill counts in README..."
          
          # Count actual skills per category
          for category in apex triggers lwc soql flows security data-modeling testing deployment integrations migration; do
            ACTUAL_COUNT=$(find .agent/skills/$category -name "*.md" 2>/dev/null | wc -l)
            if [ "$ACTUAL_COUNT" -gt 0 ]; then
              # Check if README mentions this count
              README_LINE=$(grep -E "^\| \`$category\`" README.md || echo "")
              if [ -n "$README_LINE" ]; then
                README_COUNT=$(echo "$README_LINE" | grep -oE "\| [0-9]+" | head -1 | grep -oE "[0-9]+")
                if [ "$README_COUNT" != "$ACTUAL_COUNT" ]; then
                  echo "::warning::Skill count mismatch for '$category': README says $README_COUNT, actual is $ACTUAL_COUNT"
                fi
              fi
            fi
          done
          
          echo "âœ… Skill count validation complete"
